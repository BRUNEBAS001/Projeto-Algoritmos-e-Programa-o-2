<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Task's To Do ‚Äî Calend√°rio</title>
  <link rel="stylesheet" href="/app.css">
  <style>
    body.dark {
      background: linear-gradient(135deg, #1e1e2e 0%, #0f0f1e 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: rgba(30, 30, 46, 0.95);
      border-bottom: 2px solid rgba(15, 153, 153, 0.3);
      padding: 20px 0;
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 30px;
    }

    .logo {
      font-size: 28px;
      color: #0f9;
      font-weight: bold;
      text-decoration: none;
    }

    nav {
      display: flex;
      gap: 20px;
    }

    nav a {
      color: #aaa;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 6px;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    nav a:hover,
    nav a.active {
      background: rgba(15, 153, 153, 0.2);
      color: #0f9;
      border-bottom: 2px solid #0f9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-info {
      color: #aaa;
      font-size: 14px;
    }

    .user-info span {
      color: #0f9;
      font-weight: bold;
    }

    .btn-logout {
      background: rgba(255, 100, 100, 0.1);
      color: #ff6464;
      border: 1px solid rgba(255, 100, 100, 0.3);
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .btn-logout:hover {
      background: rgba(255, 100, 100, 0.2);
      border-color: #ff6464;
    }

    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px 40px;
    }

    .page-title {
      font-size: 32px;
      color: #0f9;
      margin-bottom: 30px;
    }

    .calendar-container {
      background: rgba(30, 30, 46, 0.95);
      border: 1px solid rgba(15, 153, 153, 0.3);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      overflow-x: auto;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .month-title {
      font-size: 24px;
      color: #0f9;
      font-weight: bold;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }

    .nav-btn {
      background: rgba(15, 153, 153, 0.2);
      color: #0f9;
      border: 1px solid rgba(15, 153, 153, 0.3);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .nav-btn:hover {
      background: rgba(15, 153, 153, 0.4);
      border-color: #0f9;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      min-height: 600px;
    }

    .day-header {
      background: rgba(15, 153, 153, 0.1);
      color: #0f9;
      padding: 15px;
      text-align: center;
      border-radius: 6px;
      font-weight: bold;
      border: 1px solid rgba(15, 153, 153, 0.2);
    }

    .day-cell {
      background: rgba(50, 50, 80, 0.3);
      border: 1px solid rgba(15, 153, 153, 0.2);
      border-radius: 8px;
      padding: 12px;
      min-height: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-y: auto;
    }

    .day-cell:hover {
      border-color: #0f9;
      background: rgba(50, 50, 80, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(15, 153, 153, 0.1);
    }

    .day-cell.other-month {
      background: rgba(30, 30, 46, 0.5);
      opacity: 0.5;
      cursor: default;
    }

    .day-cell.other-month:hover {
      transform: none;
      border-color: rgba(15, 153, 153, 0.2);
      background: rgba(30, 30, 46, 0.5);
    }

    .day-cell.today {
      border: 2px solid #0f9;
      background: rgba(15, 153, 153, 0.15);
    }

    .day-number {
      font-size: 14px;
      font-weight: bold;
      color: #0f9;
      margin-bottom: 8px;
    }

    .day-cell.other-month .day-number {
      color: #666;
    }

    .day-tasks {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
    }

    .day-task {
      background: rgba(15, 153, 153, 0.2);
      color: #0f9;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-left: 2px solid #0f9;
    }

    .day-task.completed {
      background: rgba(0, 255, 100, 0.1);
      color: #77bb77;
      border-left-color: #77bb77;
      text-decoration: line-through;
      opacity: 0.7;
    }

    .day-task.overdue {
      background: rgba(255, 100, 100, 0.2);
      color: #ff8888;
      border-left-color: #ff8888;
    }

    .day-task-count {
      font-size: 10px;
      color: #888;
      margin-top: 4px;
      text-align: right;
    }

    .day-add-btn {
      margin-top: auto;
      background: rgba(15, 153, 153, 0.1);
      color: #0f9;
      border: 1px solid rgba(15, 153, 153, 0.3);
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .day-add-btn:hover {
      background: rgba(15, 153, 153, 0.3);
      border-color: #0f9;
    }

    .legend {
      display: flex;
      gap: 20px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(15, 153, 153, 0.2);
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #aaa;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid currentColor;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 30, 46, 0.95);
      border: 1px solid rgba(15, 153, 153, 0.3);
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      color: #0f9;
      font-size: 20px;
      margin-bottom: 20px;
    }

    .modal-date {
      color: #aaa;
      font-size: 14px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(15, 153, 153, 0.2);
    }

    .modal-tasks {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .modal-task {
      background: rgba(50, 50, 80, 0.5);
      border-left: 3px solid #0f9;
      padding: 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-task:hover {
      background: rgba(50, 50, 80, 0.8);
      transform: translateX(5px);
    }

    .modal-task.completed {
      border-left-color: #77bb77;
      opacity: 0.6;
    }

    .modal-task-title {
      color: #fff;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .modal-task-desc {
      color: #aaa;
      font-size: 12px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-modal {
      flex: 1;
      padding: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .btn-modal-add {
      background: linear-gradient(135deg, #0f9 0%, #0a7a7a 100%);
      color: #000;
    }

    .btn-modal-add:hover {
      background: linear-gradient(135deg, #00ffaa 0%, #00cccc 100%);
    }

    .btn-modal-close {
      background: rgba(15, 153, 153, 0.1);
      color: #0f9;
      border: 1px solid rgba(15, 153, 153, 0.3);
    }

    .btn-modal-close:hover {
      background: rgba(15, 153, 153, 0.2);
    }

    @media (max-width: 1024px) {
      .calendar {
        grid-template-columns: repeat(7, minmax(80px, 1fr));
      }

      .day-cell {
        min-height: 100px;
        padding: 8px;
      }

      .day-number {
        font-size: 12px;
      }

      .day-task {
        font-size: 10px;
      }
    }

    @media (max-width: 768px) {
      .calendar {
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
      }

      .day-cell {
        min-height: 80px;
        padding: 6px;
      }

      .day-number {
        font-size: 11px;
      }

      .day-task {
        font-size: 9px;
      }

      .legend {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body class="dark">
  <header>
    <div class="header-content">
      <div class="header-left">
        <a href="/dashboard.html" class="logo">üìù Task's To Do</a>
        <nav>
          <a href="/dashboard.html">üìä Dashboard</a>
          <a href="/adicionar-tarefa.html">‚ûï Nova Tarefa</a>
          <a href="/calendario.html" class="active">üìÖ Calend√°rio</a>
        </nav>
      </div>
      <div class="header-right">
        <div class="user-info">Usu√°rio: <span id="userDisplay"></span></div>
        <button id="btnLogout" class="btn-logout">üö™ Sair</button>
      </div>
    </div>
  </header>

  <main>
    <h1 class="page-title">üìÖ Calend√°rio de Tarefas</h1>

    <div class="calendar-container">
      <div class="calendar-header">
        <h2 class="month-title" id="monthTitle"></h2>
        <div class="nav-buttons">
          <button class="nav-btn" onclick="previousMonth()">‚Üê Anterior</button>
          <button class="nav-btn" onclick="today()">üìç Hoje</button>
          <button class="nav-btn" onclick="nextMonth()">Pr√≥ximo ‚Üí</button>
        </div>
      </div>

      <div class="calendar" id="calendar"></div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: rgba(15, 153, 153, 0.2); border-color: #0f9;"></div>
          <span>Tarefa Pendente</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: rgba(0, 255, 100, 0.1); border-color: #77bb77;"></div>
          <span>Tarefa Conclu√≠da</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: rgba(255, 100, 100, 0.2); border-color: #ff8888;"></div>
          <span>Tarefa Vencida</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="border: 2px solid #0f9;"></div>
          <span>Hoje</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 class="modal-title">üìã Tarefas do Dia</h3>
      <div class="modal-date" id="modalDate"></div>
      <div class="modal-tasks" id="modalTasks"></div>
      <div class="modal-buttons">
        <a href="/adicionar-tarefa.html" class="btn-modal btn-modal-add">‚ûï Nova Tarefa</a>
        <button class="btn-modal btn-modal-close" onclick="closeModal()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = localStorage.getItem('currentUser');
    let currentDate = new Date();
    let allTasks = [];
    let selectedDate = null;

    // Verificar autentica√ß√£o
    window.addEventListener('DOMContentLoaded', function() {
      if (!currentUser) {
        window.location.href = '/login.html';
        return;
      }
      document.getElementById('userDisplay').textContent = '#' + currentUser;
      loadTasks();
    });

    // Logout
    document.getElementById('btnLogout').addEventListener('click', function() {
      if (confirm('Tem certeza que deseja sair?')) {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('rememberUsername');
        window.location.href = '/login.html';
      }
    });

    // Carregar tarefas
    function loadTasks() {
      fetch(`/api/tasks/user/${currentUser}`)
        .then(r => r.json())
        .then(tasks => {
          allTasks = tasks || [];
          renderCalendar();
        })
        .catch(e => console.error('Erro:', e));
    }

    // Navegar para m√™s anterior
    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    // Navegar para m√™s pr√≥ximo
    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    // Ir para hoje
    function today() {
      currentDate = new Date();
      renderCalendar();
    }

    // Renderizar calend√°rio
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      // Atualizar t√≠tulo
      document.getElementById('monthTitle').textContent = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

      // Limpar calend√°rio
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      // Cabe√ßalho dos dias da semana
      const daysOfWeek = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB'];
      daysOfWeek.forEach(day => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = day;
        calendar.appendChild(header);
      });

      // Dias do m√™s anterior
      const prevMonth = new Date(year, month, 0);
      const daysInPrevMonth = prevMonth.getDate();
      for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const cell = createDayCell(day, month - 1, year, true);
        calendar.appendChild(cell);
      }

      // Dias do m√™s atual
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = createDayCell(day, month, year, false);
        calendar.appendChild(cell);
      }

      // Dias do pr√≥ximo m√™s
      const remainingDays = 42 - (startingDayOfWeek + daysInMonth);
      for (let day = 1; day <= remainingDays; day++) {
        const cell = createDayCell(day, month + 1, year, true);
        calendar.appendChild(cell);
      }
    }

    // Criar c√©lula de dia
    function createDayCell(day, month, year, isOtherMonth) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      if (isOtherMonth) cell.classList.add('other-month');

      // Verificar se √© hoje
      const today = new Date();
      if (!isOtherMonth && day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
        cell.classList.add('today');
      }

      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = day;
      cell.appendChild(dayNumber);

      const tasksDiv = document.createElement('div');
      tasksDiv.className = 'day-tasks';

      // Adicionar tarefas
      const cellDate = new Date(year, month, day);
      const tasksForDay = allTasks.filter(task => {
        if (!task.dueDate) return false;
        const taskDate = new Date(task.dueDate);
        return taskDate.getDate() === cellDate.getDate() &&
               taskDate.getMonth() === cellDate.getMonth() &&
               taskDate.getFullYear() === cellDate.getFullYear();
      }).slice(0, 3);

      tasksForDay.forEach(task => {
        const taskEl = document.createElement('div');
        taskEl.className = 'day-task';
        if (task.completed) taskEl.classList.add('completed');
        if (!task.completed && new Date(task.dueDate) < new Date() && new Date(task.dueDate).toDateString() !== new Date().toDateString()) {
          taskEl.classList.add('overdue');
        }
        taskEl.textContent = task.title;
        taskEl.title = task.title;
        taskEl.onclick = (e) => {
          e.stopPropagation();
          showDayTasks(cellDate);
        };
        tasksDiv.appendChild(taskEl);
      });

      const tasksForDayTotal = allTasks.filter(task => {
        if (!task.dueDate) return false;
        const taskDate = new Date(task.dueDate);
        return taskDate.getDate() === cellDate.getDate() &&
               taskDate.getMonth() === cellDate.getMonth() &&
               taskDate.getFullYear() === cellDate.getFullYear();
      }).length;

      if (tasksForDayTotal > 3) {
        const count = document.createElement('div');
        count.className = 'day-task-count';
        count.textContent = `+${tasksForDayTotal - 3} mais`;
        tasksDiv.appendChild(count);
      }

      if (!isOtherMonth) {
        const addBtn = document.createElement('button');
        addBtn.className = 'day-add-btn';
        addBtn.textContent = '‚ûï';
        addBtn.onclick = () => showDayTasks(cellDate);
        cell.appendChild(addBtn);
      }

      cell.appendChild(tasksDiv);
      cell.onclick = () => !isOtherMonth && showDayTasks(cellDate);

      return cell;
    }

    // Mostrar tarefas do dia
    function showDayTasks(date) {
      selectedDate = date;
      
      const tasksForDay = allTasks.filter(task => {
        if (!task.dueDate) return false;
        const taskDate = new Date(task.dueDate);
        return taskDate.getDate() === date.getDate() &&
               taskDate.getMonth() === date.getMonth() &&
               taskDate.getFullYear() === date.getFullYear();
      });

      document.getElementById('modalDate').textContent = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });

      const tasksDiv = document.getElementById('modalTasks');
      tasksDiv.innerHTML = tasksForDay.length === 0 
        ? '<p style="color: #888; text-align: center;">Nenhuma tarefa neste dia</p>'
        : tasksForDay.map(task => `
          <div class="modal-task ${task.completed ? 'completed' : ''}" onclick="window.location.href='/editar-tarefa.html?id=${task.id}'">
            <div class="modal-task-title">${task.title}</div>
            ${task.description ? `<div class="modal-task-desc">${task.description}</div>` : ''}
          </div>
        `).join('');

      // Atualizar link do bot√£o "Nova Tarefa" com a data formatada
      const dateStr = date.toISOString().split('T')[0]; // Formato: YYYY-MM-DD
      const addTaskBtn = document.querySelector('.btn-modal-add');
      addTaskBtn.href = `/adicionar-tarefa.html?date=${dateStr}`;

      document.getElementById('modal').classList.add('active');
    }

    // Fechar modal
    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    // Fechar modal ao clicar fora
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
  </script>
</body>
</html>
